<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#0f1a14"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Biblioteca"/>
<link rel="manifest" href="#" id="pwa-manifest"/>
<link rel="apple-touch-icon" href="#" id="apple-icon"/>
<title>Biblioteca Personal</title>
<script>
(function initPWA() {
  const ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <rect width="512" height="512" rx="100" fill="#0f1a14"/>
    <radialGradient id="g" cx="50%" cy="45%" r="60%">
      <stop offset="0%" stop-color="#4ade80" stop-opacity="0.15"/>
      <stop offset="100%" stop-color="#0f1a14" stop-opacity="0"/>
    </radialGradient>
    <rect width="512" height="512" rx="100" fill="url(#g)"/>
    <!-- Libro izquierdo -->
    <rect x="80" y="140" width="72" height="240" rx="8" fill="#1c2a1f"/>
    <rect x="80" y="140" width="72" height="240" rx="8" fill="none" stroke="#4ade80" stroke-width="2" opacity="0.5"/>
    <rect x="80" y="140" width="14" height="240" rx="4" fill="#4ade80" opacity="0.7"/>
    <!-- Libro central (mÃ¡s alto) -->
    <rect x="172" y="100" width="88" height="280" rx="8" fill="#1c2a1f"/>
    <rect x="172" y="100" width="88" height="280" rx="8" fill="none" stroke="#4ade80" stroke-width="2" opacity="0.7"/>
    <rect x="172" y="100" width="16" height="280" rx="4" fill="#4ade80" opacity="0.9"/>
    <rect x="196" y="130" width="48" height="3" rx="2" fill="#d4a853" opacity="0.6"/>
    <rect x="196" y="145" width="36" height="2" rx="1" fill="#6b8570" opacity="0.5"/>
    <rect x="196" y="156" width="42" height="2" rx="1" fill="#6b8570" opacity="0.4"/>
    <!-- Libro derecho -->
    <rect x="280" y="130" width="78" height="250" rx="8" fill="#1c2a1f"/>
    <rect x="280" y="130" width="78" height="250" rx="8" fill="none" stroke="#4ade80" stroke-width="2" opacity="0.5"/>
    <rect x="280" y="130" width="14" height="250" rx="4" fill="#4ade80" opacity="0.6"/>
    <!-- Libro pequeÃ±o derecha -->
    <rect x="378" y="190" width="54" height="190" rx="8" fill="#1c2a1f"/>
    <rect x="378" y="190" width="54" height="190" rx="8" fill="none" stroke="#4ade80" stroke-width="2" opacity="0.35"/>
    <rect x="378" y="190" width="12" height="190" rx="4" fill="#4ade80" opacity="0.4"/>
    <!-- LÃ­nea base -->
    <rect x="70" y="388" width="372" height="4" rx="2" fill="#4ade80" opacity="0.25"/>
    <!-- Destellos -->
    <circle cx="420" cy="140" r="5" fill="#d4a853" opacity="0.5"/>
    <circle cx="80"  cy="410" r="4" fill="#4ade80" opacity="0.3"/>
  </svg>`;

  const iconBlob = new Blob([ICON_SVG], { type: 'image/svg+xml' });
  const iconUrl  = URL.createObjectURL(iconBlob);
  document.getElementById('apple-icon').href = iconUrl;

  const manifest = {
    name: 'Biblioteca Personal',
    short_name: 'Biblioteca',
    description: 'Tu colecciÃ³n personal de libros â€” biblioteca, leÃ­dos y estadÃ­sticas.',
    start_url: './',
    display: 'standalone',
    background_color: '#0f1a14',
    theme_color: '#0f1a14',
    orientation: 'portrait',
    lang: 'es',
    icons: [
      { src: iconUrl, sizes: '192x192', type: 'image/svg+xml' },
      { src: iconUrl, sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable' }
    ]
  };
  const mBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  document.getElementById('pwa-manifest').href = URL.createObjectURL(mBlob);

  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE = 'biblioteca-v1';
      self.addEventListener('install', e => {
        self.skipWaiting();
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/']).catch(() => {})));
      });
      self.addEventListener('activate', e => {
        e.waitUntil(
          caches.keys().then(keys =>
            Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
          ).then(() => self.clients.claim())
        );
      });
      self.addEventListener('fetch', e => {
        e.respondWith(
          caches.match(e.request).then(r => r || fetch(e.request).then(res => {
            if (res && res.status === 200) {
              const clone = res.clone();
              caches.open(CACHE).then(c => c.put(e.request, clone));
            }
            return res;
          }).catch(() => caches.match('/')))
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(() => {});
  }
})();
</script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:       #0f1a14;
  --surface:  #162019;
  --card:     #1c2a1f;
  --border:   #2a3d2f;
  --green:    #4ade80;
  --green2:   #22c55e;
  --gold:     #d4a853;
  --cream:    #f0e8d8;
  --muted:    #6b8570;
  --danger:   #e05555;
  --r:        10px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--cream);min-height:100vh;overflow-x:hidden}
input,select,textarea,button{font-family:inherit}

/* â”€â”€ HEADER â”€â”€ */
.header{
  background:linear-gradient(160deg,#0a1a0d 0%,#162019 100%);
  padding:28px 20px 20px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:16px;
  position:sticky;top:0;z-index:50;
  backdrop-filter:blur(12px);
}
.logo-wrap{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(135deg,#1e3a28,#2d5a3a);
  border:1px solid #3a6a45;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;box-shadow:0 4px 16px #00000066;
}
.logo-svg{width:28px;height:28px}
.header-text h1{
  font-family:'Playfair Display',serif;
  font-size:20px;font-weight:700;
  color:var(--cream);letter-spacing:0.5px;
  line-height:1.1;
}
.header-text p{font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-top:2px}
.header-stats{margin-left:auto;text-align:right;flex-shrink:0}
.header-stats .num{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--green);line-height:1}
.header-stats .lbl{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}

/* â”€â”€ NAV â”€â”€ */
.nav{
  display:flex;background:var(--surface);
  border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;flex-shrink:0;
  position:sticky;top:89px;z-index:40;
}
.nav::-webkit-scrollbar{display:none}
.nav-btn{
  padding:13px 18px;background:transparent;border:none;
  color:var(--muted);cursor:pointer;font-size:12px;font-weight:500;
  border-bottom:2px solid transparent;white-space:nowrap;
  transition:all .2s;letter-spacing:.3px;
}
.nav-btn.active{color:var(--cream);border-bottom-color:var(--green)}
.nav-btn:hover:not(.active){color:var(--cream)}

/* â”€â”€ PAGE â”€â”€ */
.page{padding:20px 16px;max-width:900px;margin:0 auto;display:none}
.page.active{display:block}

/* â”€â”€ SECTION HEADER â”€â”€ */
.sh{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;gap:12px}
.sh-left h2{font-family:'Playfair Display',serif;font-size:22px;color:var(--cream);font-weight:700}
.sh-left p{font-size:11px;color:var(--muted);margin-top:3px;letter-spacing:.5px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  padding:9px 18px;border-radius:8px;border:none;cursor:pointer;
  font-weight:600;font-size:13px;font-family:inherit;
  transition:all .15s;letter-spacing:.2px;
}
.btn-primary{background:var(--green);color:#0a1a0d}
.btn-primary:hover{background:var(--green2);transform:translateY(-1px)}
.btn-ghost{background:rgba(255,255,255,.06);color:var(--cream);border:1px solid var(--border)}
.btn-ghost:hover{background:rgba(255,255,255,.1)}
.btn-sm{padding:5px 12px;font-size:11px}
.btn-danger{background:rgba(224,85,85,.15);color:#f99;border:1px solid rgba(224,85,85,.3)}
.btn-danger:hover{background:rgba(224,85,85,.25)}
.btn-icon{background:rgba(74,222,128,.12);color:var(--green);border:none;padding:5px 9px;border-radius:6px;cursor:pointer;font-size:12px;transition:background .15s}
.btn-icon:hover{background:rgba(74,222,128,.22)}
.btn-icon.del{background:rgba(224,85,85,.12);color:#f99}
.btn-icon.del:hover{background:rgba(224,85,85,.22)}

/* â”€â”€ FILTERS â”€â”€ */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.inp{
  background:rgba(0,0,0,.35);border:1px solid var(--border);
  border-radius:8px;padding:9px 12px;color:var(--cream);
  font-size:13px;font-family:inherit;outline:none;
  transition:border-color .15s;
}
.inp:focus{border-color:var(--green)}
.inp::placeholder{color:var(--muted)}
.sel{background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--cream);font-size:12px;font-family:inherit;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b8570' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.sel option{background:#162019}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--card)}
th{padding:11px 12px;text-align:left;color:var(--gold);font-weight:600;font-size:11px;letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid rgba(42,61,47,.5)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.read-check{color:var(--green);font-size:11px;margin-right:4px}
.badge-leido{font-size:10px;color:var(--green);font-weight:600;letter-spacing:.5px}
.badge-pend{font-size:10px;color:#445}

/* â”€â”€ GENRE TAGS â”€â”€ */
.genres{display:flex;flex-wrap:wrap;gap:4px}
.gtag{font-size:10px;padding:2px 8px;border-radius:10px;border:1px solid;white-space:nowrap}

/* â”€â”€ CARDS GRID â”€â”€ */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.card{
  background:var(--card);border-radius:var(--r);padding:15px;
  border:1px solid var(--border);
  transition:border-color .2s,transform .2s;
  position:relative;overflow:hidden;
}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--green),transparent)}
.card:hover{border-color:var(--green);transform:translateY(-2px)}
.card-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--cream);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-author{font-size:11px;color:var(--muted);margin-bottom:10px}
.card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.meta-chip{font-size:10px;background:rgba(255,255,255,.07);padding:2px 8px;border-radius:10px;color:var(--muted)}
.meta-chip.mes{background:rgba(74,222,128,.1);color:var(--green)}
.card-actions{position:absolute;top:12px;right:12px;display:flex;gap:4px}

/* â”€â”€ SCORE BAR â”€â”€ */
.score-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.score-bar-wrap{flex:1;background:#1a3020;border-radius:3px;height:6px}
.score-bar{height:6px;border-radius:3px;background:linear-gradient(90deg,var(--green2),#86efac);transition:width .5s}
.score-num{font-size:14px;font-weight:700;color:var(--green);font-family:'Playfair Display',serif;min-width:28px;text-align:right}
.score-sub{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:8px}
.score-sub-item{font-size:10px;color:var(--muted)}
.score-sub-item span{color:var(--cream)}

/* â”€â”€ TOTAL SCORE BIG â”€â”€ */
.total-big{font-family:'Playfair Display',serif;font-size:28px;font-weight:900;color:var(--green)}

/* â”€â”€ STAT CARDS â”€â”€ */
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.stat-card{background:var(--card);border-radius:var(--r);padding:16px 12px;text-align:center;border:1px solid var(--border);border-bottom:2px solid var(--green)}
.stat-num{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--green)}
.stat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* â”€â”€ BAR CHART â”€â”€ */
.bar-row{margin-bottom:10px}
.bar-label{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;color:var(--cream)}
.bar-label span{color:var(--green)}
.bar-bg{background:#1a3020;border-radius:3px;height:8px}
.bar-fill{height:8px;border-radius:3px;background:linear-gradient(90deg,var(--green2),#86efac)}

/* â”€â”€ MONTH CHART â”€â”€ */
.month-chart{display:flex;align-items:flex-end;gap:6px;height:130px;overflow-x:auto;padding-bottom:4px}
.month-col{display:flex;flex-direction:column;align-items:center;min-width:32px}
.month-bar{width:20px;border-radius:3px 3px 0 0;background:linear-gradient(0deg,var(--green2),#86efac);position:relative;transition:height .5s}
.month-bar-num{position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--green);white-space:nowrap}
.month-lbl{font-size:9px;color:var(--muted);margin-top:4px}

/* â”€â”€ RANKING â”€â”€ */
.rank-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(42,61,47,.5)}
.rank-row:last-child{border-bottom:none}
.rank-num{width:28px;height:28px;border-radius:50%;background:#1a3020;color:var(--muted);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0}
.rank-num.top{background:var(--green);color:#0a1a0d}
.rank-info{flex:1;min-width:0}
.rank-title{font-size:13px;color:var(--cream);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.rank-author{font-size:11px;color:var(--muted)}

/* â”€â”€ RANDOM â”€â”€ */
.random-btn{
  width:100%;padding:18px;border-radius:12px;border:2px dashed var(--border);
  background:transparent;color:var(--muted);font-size:14px;cursor:pointer;
  font-family:inherit;font-weight:600;letter-spacing:.5px;
  transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px;
}
.random-btn:hover{border-color:var(--green);color:var(--green);background:rgba(74,222,128,.05)}
.random-result{
  background:var(--card);border-radius:14px;padding:28px;text-align:center;
  border:2px solid var(--green);margin-top:20px;
  animation:fadeIn .4s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.random-result .rr-icon{font-size:48px;margin-bottom:12px}
.random-result .rr-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--cream);margin-bottom:6px}
.random-result .rr-author{font-size:13px;color:var(--muted)}

/* â”€â”€ COMPRAR â”€â”€ */
.buy-card{
  background:var(--card);border-radius:var(--r);padding:15px;
  border:1px solid var(--border);display:flex;gap:14px;align-items:center;
  transition:border-color .2s;
}
.buy-card:hover{border-color:var(--gold)}
.buy-score{font-family:'Playfair Display',serif;font-size:32px;font-weight:900;color:var(--green);flex-shrink:0;width:48px;text-align:center}
.buy-info{flex:1;min-width:0}
.buy-title{font-size:14px;font-weight:600;color:var(--cream);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.buy-author{font-size:11px;color:var(--muted);margin-top:2px}
.buy-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:14px;padding:24px;width:100%;max-width:540px;max-height:92vh;overflow-y:auto;border:1px solid var(--border);animation:fadeIn .25s ease}
.modal h2{font-family:'Playfair Display',serif;font-size:18px;color:var(--cream);margin-bottom:20px}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-head h2{margin-bottom:0}
.close-btn{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;padding:0}

/* â”€â”€ FORM â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.form-grid.full{grid-template-columns:1fr}
.field{display:flex;flex-direction:column;gap:5px}
.field.span2{grid-column:1/-1}
.field label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
.slider-row{margin-bottom:8px}
.slider-row label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:4px}
.slider-row label span{color:var(--gold);font-weight:600}
input[type=range]{width:100%;accent-color:var(--green);cursor:pointer}
.score-box{background:rgba(0,0,0,.3);border-radius:8px;padding:14px;margin:12px 0}
.score-box h3{font-size:12px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.score-result{font-size:15px;color:var(--green);font-weight:700;margin-top:10px}

/* â”€â”€ GENRE MULTI â”€â”€ */
.genre-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.genre-chip{
  padding:4px 11px;border-radius:12px;border:1px solid var(--border);
  background:transparent;color:var(--muted);font-size:11px;
  cursor:pointer;transition:all .15s;font-family:inherit;
}
.genre-chip.on{border-color:var(--green);background:rgba(74,222,128,.12);color:var(--green)}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:48px 20px;color:var(--muted)}
.empty .empty-icon{font-size:40px;margin-bottom:12px}
.empty p{font-size:14px}

/* â”€â”€ SPINNER â”€â”€ */
.spinner{display:flex;justify-content:center;padding:40px}
.spin{width:32px;height:32px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--green);color:#0a1a0d;padding:10px 20px;border-radius:24px;
  font-weight:600;font-size:13px;z-index:500;transition:transform .3s;white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:520px){
  .form-grid{grid-template-columns:1fr}
  .field.span2{grid-column:1}
  .stat-grid{grid-template-columns:repeat(3,1fr)}
  .header{padding:20px 14px 14px}
  .page{padding:16px 12px}
}
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- HEADER -->
<div class="header">
  <div class="logo-wrap">
    <svg class="logo-svg" viewBox="0 0 28 28" fill="none">
      <rect x="3" y="4" width="7" height="20" rx="1.5" fill="#4ade80" opacity=".9"/>
      <rect x="11.5" y="2" width="7" height="22" rx="1.5" fill="#4ade80" opacity=".7"/>
      <rect x="20" y="5" width="5" height="18" rx="1.5" fill="#4ade80" opacity=".5"/>
      <path d="M3 19h22" stroke="#22c55e" stroke-width="1" opacity=".4"/>
    </svg>
  </div>
  <div class="header-text">
    <h1>Biblioteca Personal</h1>
    <p>Mi colecciÃ³n de libros</p>
  </div>
  <div class="header-stats">
    <div class="num" id="stat-total">0</div>
    <div class="lbl">libros</div>
  </div>
</div>

<!-- NAV -->
<div class="nav">
  <button class="nav-btn active" data-page="biblioteca">ğŸ“š Biblioteca</button>
  <button class="nav-btn" data-page="leidos">âœ… LeÃ­dos</button>
  <button class="nav-btn" data-page="estadisticas">ğŸ“Š Stats</button>
  <button class="nav-btn" data-page="aleatorio">ğŸ² Aleatorio</button>
  <button class="nav-btn" data-page="comprar">ğŸ›’ Comprar</button>
</div>

<!-- PAGES -->
<div id="p-biblioteca" class="page active">
  <div class="sh">
    <div class="sh-left"><h2>Mi Biblioteca</h2><p id="bib-count">Cargando...</p></div>
    <button class="btn btn-primary" onclick="openBibForm()">+ AÃ±adir</button>
  </div>
  <div class="filters">
    <input class="inp" id="bib-search" placeholder="Buscar tÃ­tulo o autor..." style="width:200px" oninput="renderBib()"/>
    <select class="sel" id="bib-genre" onchange="renderBib()">
      <option value="">Todos los gÃ©neros</option>
    </select>
    <button class="btn btn-ghost btn-sm" onclick="clearBibFilters()" id="bib-clear" style="display:none">âœ• Limpiar</button>
  </div>
  <div class="tbl-wrap">
    <table><thead><tr>
      <th>#</th><th>TÃ­tulo</th><th>Autor</th><th>GÃ©neros</th><th>Estado</th><th></th>
    </tr></thead>
    <tbody id="bib-tbody"></tbody></table>
  </div>
  <div id="bib-empty" class="empty" style="display:none">
    <div class="empty-icon">ğŸ“š</div>
    <p>Tu biblioteca estÃ¡ vacÃ­a.<br>Â¡AÃ±ade tu primer libro!</p>
  </div>
</div>

<div id="p-leidos" class="page">
  <div class="sh">
    <div class="sh-left"><h2>Libros LeÃ­dos</h2><p id="leidos-count">0 libros</p></div>
    <button class="btn btn-primary" onclick="openLeidoForm()">+ AÃ±adir leÃ­do</button>
  </div>
  <div class="filters">
    <select class="sel" id="l-genre" onchange="renderLeidos()">
      <option value="">Todos gÃ©neros</option>
    </select>
    <select class="sel" id="l-mes" onchange="renderLeidos()">
      <option value="">Todos los meses</option>
    </select>
    <input class="inp" id="l-search" placeholder="Buscar..." style="width:140px" oninput="renderLeidos()"/>
  </div>
  <div class="cards" id="leidos-cards"></div>
  <div id="leidos-empty" class="empty" style="display:none">
    <div class="empty-icon">âœ¨</div>
    <p>AÃºn no has registrado ningÃºn libro leÃ­do.</p>
  </div>
</div>

<div id="p-estadisticas" class="page">
  <div class="sh"><div class="sh-left"><h2>EstadÃ­sticas</h2><p>Tu aÃ±o en libros</p></div></div>
  <div class="stat-grid" id="stat-grid"></div>
  <div style="background:var(--card);border-radius:var(--r);padding:16px;margin-bottom:14px;border:1px solid var(--border)">
    <div style="font-size:12px;color:var(--gold);margin-bottom:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px">ğŸ“… Libros por mes</div>
    <div class="month-chart" id="month-chart"></div>
  </div>
  <div style="background:var(--card);border-radius:var(--r);padding:16px;margin-bottom:14px;border:1px solid var(--border)">
    <div style="font-size:12px;color:var(--gold);margin-bottom:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px">ğŸ“– Autores mÃ¡s leÃ­dos</div>
    <div id="author-chart"></div>
  </div>
  <div style="background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--border)">
    <div style="font-size:12px;color:var(--gold);margin-bottom:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px">ğŸ† Ranking por nota</div>
    <div id="ranking"></div>
  </div>
</div>

<div id="p-aleatorio" class="page">
  <div class="sh"><div class="sh-left"><h2>Libro Aleatorio</h2><p>DÃ©jate sorprender</p></div></div>
  <div class="filters">
    <select class="sel" id="rand-genre"><option value="">Cualquier gÃ©nero</option></select>
    <select class="sel" id="rand-autor"><option value="">Cualquier autor</option></select>
  </div>
  <div id="rand-pool" style="font-size:12px;color:var(--muted);margin-bottom:20px"></div>
  <button class="random-btn" onclick="doRandom()">
    <span style="font-size:22px">ğŸ²</span> Â¡RecomiÃ©ndame un libro!
  </button>
  <div id="rand-result" style="display:none"></div>
</div>

<div id="p-comprar" class="page">
  <div class="sh"><div class="sh-left"><h2>Lista de Compra</h2><p>Ebooks leÃ­dos con nota â‰¥ 7 Â· candidatos a papel</p></div></div>
  <div class="buy-list" id="buy-list"></div>
  <div id="buy-empty" class="empty" style="display:none">
    <div class="empty-icon">ğŸ›’</div>
    <p>NingÃºn ebook supera el 7 aÃºn.</p>
  </div>
</div>

<!-- MODAL BIBLIOTECA -->
<div class="modal-overlay" id="bib-modal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="bib-modal-title">AÃ±adir libro</h2>
      <button class="close-btn" onclick="closeBibModal()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="field span2">
        <label>TÃ­tulo *</label>
        <input class="inp" id="bm-titulo" placeholder="TÃ­tulo del libro" style="width:100%"/>
      </div>
      <div class="field">
        <label>Autor</label>
        <input class="inp" id="bm-autor" placeholder="Nombre del autor" style="width:100%"/>
      </div>
      <div class="field">
        <label>PÃ¡ginas</label>
        <input class="inp" id="bm-paginas" type="number" placeholder="nÂº pÃ¡ginas" style="width:100%"/>
      </div>
      <div class="field span2">
        <label>GÃ©neros (puedes elegir varios)</label>
        <div class="genre-grid" id="bm-genres"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-ghost" onclick="closeBibModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveBib()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL LEÃDO -->
<div class="modal-overlay" id="leido-modal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="lm-title">Registrar lectura</h2>
      <button class="close-btn" onclick="closeLeidoModal()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="field span2">
        <label>TÃ­tulo * (autocompleta de biblioteca)</label>
        <input class="inp" id="lm-titulo" list="lm-datalist" placeholder="Escribe o elige de la lista..." style="width:100%" oninput="autofillLeido(this.value)"/>
        <datalist id="lm-datalist"></datalist>
      </div>
      <div class="field">
        <label>Autor</label>
        <input class="inp" id="lm-autor" style="width:100%"/>
      </div>
      <div class="field">
        <label>PÃ¡ginas</label>
        <input class="inp" id="lm-paginas" type="number" style="width:100%"/>
      </div>
      <div class="field">
        <label>Formato</label>
        <select class="sel" id="lm-formato" style="width:100%">
          <option>Ebook</option><option>Papel</option>
        </select>
      </div>
      <div class="field">
        <label>Mes leÃ­do</label>
        <select class="sel" id="lm-mes" style="width:100%"></select>
      </div>
      <div class="field span2">
        <label>GÃ©neros</label>
        <div class="genre-grid" id="lm-genres"></div>
      </div>
    </div>
    <div class="score-box">
      <h3>PuntuaciÃ³n (0 â€“ 10)</h3>
      <div id="lm-sliders"></div>
      <div class="score-result">Media: <span id="lm-avg">0</span> / 10</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeLeidoModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveLeido()">Guardar</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GENEROS = ['Amor y familia','Autoayuda','BiologÃ­a','Ciencia','Dinero y finanzas','FantasÃ­a','FicciÃ³n','FilosofÃ­a','FÃ­sica','Historia','IngenierÃ­a','Lectura','Literatura','Memorias','Negocios','PoesÃ­a','PolÃ­tica','Productividad','PsicologÃ­a','Realizamiento','Research','Romance','Salud','Work-life balance'];
const MESES   = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const CATEGORIAS = ['personaje','prosa','trama','aprendizaje','entretenimiento'];
const CAT_LABELS = ['ğŸ‘¤ Personaje','âœï¸ Prosa','ğŸ“– Trama','ğŸ§  Aprendizaje','ğŸ­ Entretenimiento'];
const GENRE_COLORS = {
  'FicciÃ³n':'#4ade80','FantasÃ­a':'#60c090','Romance':'#ff9ab0','PsicologÃ­a':'#7ab4d4',
  'FilosofÃ­a':'#c4b464','Negocios':'#9ad464','Historia':'#d4a464','Salud':'#64d4b4',
  'PoesÃ­a':'#d48ad4','Ciencia':'#64b4d4','FÃ­sica':'#d46464','Research':'#a0a0a0',
  'PolÃ­tica':'#e0a050','BiologÃ­a':'#80d480','Literatura':'#b0a0d4',
};

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getData(key,def){ try{ return JSON.parse(localStorage.getItem(key))||def }catch{ return def } }
function setData(key,val){ localStorage.setItem(key,JSON.stringify(val)) }

let biblioteca = getData('bib',[]);
let leidos     = getData('leidos',[]);

function saveBiblioteca(){ setData('bib',biblioteca) }
function saveLeidos(){ setData('leidos',leidos) }

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', ()=>{
  // Populate genre selects
  const gs = [document.getElementById('bib-genre'), document.getElementById('l-genre'), document.getElementById('rand-genre')];
  GENEROS.forEach(g=>{ gs.forEach(s=>{ const o=document.createElement('option'); o.value=o.textContent=g; s.appendChild(o) }) });
  MESES.forEach(m=>{ const o=document.createElement('option'); o.value=o.textContent=m; document.getElementById('l-mes').appendChild(o) });
  buildGenreChips('bm-genres',[],'bib');
  buildGenreChips('lm-genres',[],'leido');
  buildSliders();
  updateRandomAutores();
  renderAll();
  // Nav
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('p-'+b.dataset.page).classList.add('active');
      if(b.dataset.page==='estadisticas') renderStats();
      if(b.dataset.page==='aleatorio') renderRandomPool();
      if(b.dataset.page==='comprar') renderComprar();
    });
  });
});

function renderAll(){ renderBib(); renderLeidos(); updateHeader(); updateRandomAutores(); }

function updateHeader(){
  document.getElementById('stat-total').textContent = biblioteca.length;
}

// â”€â”€â”€ GENRE CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bibSelectedGenres = [];
let leidoSelectedGenres = [];

function buildGenreChips(containerId, selected, ns){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML='';
  GENEROS.forEach(g=>{
    const b=document.createElement('button');
    b.type='button';b.className='genre-chip'+(selected.includes(g)?' on':'');
    b.textContent=g;
    b.onclick=()=>{
      b.classList.toggle('on');
      if(ns==='bib'){
        bibSelectedGenres=bibSelectedGenres.includes(g)?bibSelectedGenres.filter(x=>x!==g):[...bibSelectedGenres,g];
      } else {
        leidoSelectedGenres=leidoSelectedGenres.includes(g)?leidoSelectedGenres.filter(x=>x!==g):[...leidoSelectedGenres,g];
        updateAvg();
      }
    };
    wrap.appendChild(b);
  });
}

// â”€â”€â”€ SLIDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSliders(){
  const wrap=document.getElementById('lm-sliders');
  CATEGORIAS.forEach((k,i)=>{
    wrap.innerHTML+=`<div class="slider-row">
      <label>${CAT_LABELS[i]}: <span id="sl-${k}">0</span></label>
      <input type="range" min="0" max="10" step="0.5" value="0" id="rng-${k}" oninput="updateSlider('${k}')"/>
    </div>`;
  });
}

function updateSlider(k){
  document.getElementById('sl-'+k).textContent=document.getElementById('rng-'+k).value;
  updateAvg();
}

function updateAvg(){
  const vals=CATEGORIAS.map(k=>parseFloat(document.getElementById('rng-'+k).value)).filter(v=>v>0);
  const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1):0;
  document.getElementById('lm-avg').textContent=avg;
}

// â”€â”€â”€ RENDER BIBLIOTECA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBib(){
  const search=document.getElementById('bib-search').value.toLowerCase();
  const genre=document.getElementById('bib-genre').value;
  document.getElementById('bib-clear').style.display=(search||genre)?'':'none';

  const leidosTitles=new Set(leidos.map(l=>l.titulo?.toLowerCase().trim()));
  const filtered=biblioteca.filter(b=>{
    const ms=!search||b.titulo?.toLowerCase().includes(search)||b.autor?.toLowerCase().includes(search);
    const mg=!genre||b.generos?.includes(genre);
    return ms&&mg;
  });

  document.getElementById('bib-count').textContent=`${biblioteca.length} libros Â· ${leidos.length} leÃ­dos`;
  const tbody=document.getElementById('bib-tbody');
  tbody.innerHTML='';
  document.getElementById('bib-empty').style.display=!filtered.length?'':'none';

  filtered.forEach((b,i)=>{
    const yl=leidosTitles.has(b.titulo?.toLowerCase().trim());
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="color:var(--muted);font-size:11px">${i+1}</td>
      <td style="color:${yl?'var(--green)':'var(--cream)'};font-weight:${yl?600:400}">
        ${yl?'<span class="read-check">âœ“</span>':''}${esc(b.titulo)}
      </td>
      <td style="color:var(--muted);font-size:11px">${esc(b.autor||'')}</td>
      <td>${genreTags(b.generos)}</td>
      <td>${yl?'<span class="badge-leido">LEÃDO</span>':'<span class="badge-pend">pendiente</span>'}</td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="btn-icon" onclick="editBib(${b.id})">âœ</button>
          <button class="btn-icon del" onclick="deleteBib(${b.id})">âœ•</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  updateHeader();
}

function clearBibFilters(){
  document.getElementById('bib-search').value='';
  document.getElementById('bib-genre').value='';
  renderBib();
}

// â”€â”€â”€ RENDER LEIDOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLeidos(){
  const genre=document.getElementById('l-genre').value;
  const mes=document.getElementById('l-mes').value;
  const search=document.getElementById('l-search').value.toLowerCase();

  const filtered=leidos.filter(b=>{
    const mg=!genre||b.generos?.includes(genre);
    const mm=!mes||b.mes===mes;
    const ms=!search||b.titulo?.toLowerCase().includes(search)||b.autor?.toLowerCase().includes(search);
    return mg&&mm&&ms;
  });

  document.getElementById('leidos-count').textContent=`${leidos.length} libros`;
  const wrap=document.getElementById('leidos-cards');
  wrap.innerHTML='';
  document.getElementById('leidos-empty').style.display=!filtered.length?'':'none';

  filtered.forEach(b=>{
    const card=document.createElement('div');
    card.className='card';
    const sub=CATEGORIAS.map(k=>`<div class="score-sub-item">${k.charAt(0).toUpperCase()+k.slice(1)}: <span>${b[k]||0}</span></div>`).join('');
    card.innerHTML=`
      <div class="card-actions">
        <button class="btn-icon" onclick="editLeido(${b.id})" style="margin-right:3px">âœ</button>
        <button class="btn-icon del" onclick="deleteLeido(${b.id})">âœ•</button>
      </div>
      <div class="card-title">${esc(b.titulo)}</div>
      <div class="card-author">${esc(b.autor||'')}</div>
      <div class="card-meta">
        ${genreTags(b.generos)}
        <span class="meta-chip">${b.formato||''}</span>
        ${b.mes?`<span class="meta-chip mes">${b.mes}</span>`:''}
      </div>
      ${b.total>0?`
      <div class="score-row">
        <div class="score-bar-wrap"><div class="score-bar" style="width:${b.total*10}%"></div></div>
        <div class="score-num">${b.total}</div>
      </div>
      <div class="score-sub">${sub}</div>`:''}`;
    wrap.appendChild(card);
  });
}

// â”€â”€â”€ RENDER STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(){
  // Pills
  const scored=leidos.filter(b=>b.total>0);
  const avg=scored.length?(scored.reduce((s,b)=>s+b.total,0)/scored.length).toFixed(1):'-';
  document.getElementById('stat-grid').innerHTML=`
    <div class="stat-card"><div class="stat-num">${biblioteca.length}</div><div class="stat-lbl">En biblioteca</div></div>
    <div class="stat-card"><div class="stat-num">${leidos.length}</div><div class="stat-lbl">LeÃ­dos</div></div>
    <div class="stat-card"><div class="stat-num">${avg}</div><div class="stat-lbl">Nota media</div></div>`;

  // Month chart
  const byMonth={};
  MESES.forEach(m=>{byMonth[m]=0});
  leidos.forEach(b=>{if(b.mes&&byMonth[b.mes]!==undefined)byMonth[b.mes]++});
  const months=MESES.map(m=>({mes:m.slice(0,3),v:byMonth[m]})).filter(m=>m.v>0);
  const maxM=Math.max(...months.map(m=>m.v),1);
  const H=110;
  document.getElementById('month-chart').innerHTML=months.length?months.map(m=>`
    <div class="month-col">
      <div class="month-bar" style="height:${(m.v/maxM)*H}px">
        ${m.v>0?`<div class="month-bar-num">${m.v}</div>`:''}
      </div>
      <div class="month-lbl">${m.mes}</div>
    </div>`).join(''):'<div class="empty"><p>Sin datos aÃºn</p></div>';

  // Author chart
  const autores={};
  leidos.forEach(b=>{if(b.autor)autores[b.autor]=(autores[b.autor]||0)+1});
  const topA=Object.entries(autores).sort((a,b)=>b[1]-a[1]).slice(0,7);
  const maxA=topA.length?topA[0][1]:1;
  document.getElementById('author-chart').innerHTML=topA.length?topA.map(([name,c])=>`
    <div class="bar-row">
      <div class="bar-label"><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%">${esc(name)}</span><span>${c}</span></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${(c/maxA)*100}%"></div></div>
    </div>`).join(''):'<div class="empty"><p>Sin datos</p></div>';

  // Ranking
  const ranked=leidos.filter(b=>b.total>0).sort((a,b)=>b.total-a.total).slice(0,10);
  document.getElementById('ranking').innerHTML=ranked.length?ranked.map((b,i)=>`
    <div class="rank-row">
      <div class="rank-num ${i<3?'top':''}">${i+1}</div>
      <div class="rank-info">
        <div class="rank-title">${esc(b.titulo)}</div>
        <div class="rank-author">${esc(b.autor||'')}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <div style="width:60px;background:#1a3020;border-radius:3px;height:6px">
          <div style="width:${b.total*10}%;height:6px;border-radius:3px;background:linear-gradient(90deg,var(--green2),#86efac)"></div>
        </div>
        <div style="font-family:'Playfair Display',serif;font-size:16px;font-weight:700;color:var(--green);min-width:24px">${b.total}</div>
      </div>
    </div>`).join(''):'<div class="empty"><p>Sin libros puntuados aÃºn</p></div>';
}

// â”€â”€â”€ RENDER ALEATORIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRandomAutores(){
  const sel=document.getElementById('rand-autor');
  const prev=sel.value;
  sel.innerHTML='<option value="">Cualquier autor</option>';
  const autores=[...new Set(biblioteca.map(b=>b.autor).filter(Boolean))].sort();
  autores.forEach(a=>{const o=document.createElement('option');o.value=o.textContent=a;sel.appendChild(o)});
  sel.value=prev;
}

function renderRandomPool(){
  const leidosSet=new Set(leidos.map(l=>l.titulo?.toLowerCase().trim()));
  const genre=document.getElementById('rand-genre').value;
  const autor=document.getElementById('rand-autor').value;
  const pool=biblioteca.filter(b=>{
    const nl=!leidosSet.has(b.titulo?.toLowerCase().trim());
    const mg=!genre||b.generos?.includes(genre);
    const ma=!autor||b.autor===autor;
    return nl&&mg&&ma;
  });
  document.getElementById('rand-pool').textContent=`${pool.length} libros disponibles`;
}

document.addEventListener('DOMContentLoaded',()=>{
  ['rand-genre','rand-autor'].forEach(id=>document.getElementById(id).addEventListener('change',renderRandomPool));
});

function doRandom(){
  const leidosSet=new Set(leidos.map(l=>l.titulo?.toLowerCase().trim()));
  const genre=document.getElementById('rand-genre').value;
  const autor=document.getElementById('rand-autor').value;
  const pool=biblioteca.filter(b=>{
    const nl=!leidosSet.has(b.titulo?.toLowerCase().trim());
    const mg=!genre||b.generos?.includes(genre);
    const ma=!autor||b.autor===autor;
    return nl&&mg&&ma;
  });
  if(!pool.length){showToast('Â¡No quedan libros con esos filtros!');return;}
  const b=pool[Math.floor(Math.random()*pool.length)];
  const res=document.getElementById('rand-result');
  res.style.display='block';
  res.innerHTML=`<div class="random-result">
    <div class="rr-icon">ğŸ“–</div>
    <div class="rr-title">${esc(b.titulo)}</div>
    <div class="rr-author">${esc(b.autor||'')}</div>
    ${b.generos?.length?`<div style="margin-top:10px">${genreTags(b.generos)}</div>`:''}
    ${b.paginas?`<div style="font-size:11px;color:var(--muted);margin-top:8px">${b.paginas} pÃ¡ginas</div>`:''}
  </div>`;
}

// â”€â”€â”€ RENDER COMPRAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComprar(){
  const list=leidos.filter(b=>b.formato==='Ebook'&&b.total>=7).sort((a,b)=>b.total-a.total);
  const wrap=document.getElementById('buy-list');
  wrap.innerHTML='';
  document.getElementById('buy-empty').style.display=!list.length?'':'none';
  list.forEach(b=>{
    const card=document.createElement('div');
    card.className='buy-card';
    card.innerHTML=`<div class="buy-score">${b.total}</div>
      <div class="buy-info">
        <div class="buy-title">${esc(b.titulo)}</div>
        <div class="buy-author">${esc(b.autor||'')}</div>
        <div style="margin-top:6px">${genreTags(b.generos)}</div>
      </div>`;
    wrap.appendChild(card);
  });
}

// â”€â”€â”€ FORMS BIBLIOTECA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingBibId = null;

function openBibForm(id=null){
  editingBibId=id;
  const b=id?biblioteca.find(x=>x.id===id):null;
  document.getElementById('bib-modal-title').textContent=b?'Editar libro':'AÃ±adir libro';
  document.getElementById('bm-titulo').value=b?.titulo||'';
  document.getElementById('bm-autor').value=b?.autor||'';
  document.getElementById('bm-paginas').value=b?.paginas||'';
  bibSelectedGenres=b?.generos?[...b.generos]:[];
  buildGenreChips('bm-genres',bibSelectedGenres,'bib');
  document.getElementById('bib-modal').classList.add('open');
  setTimeout(()=>document.getElementById('bm-titulo').focus(),100);
}

function closeBibModal(){ document.getElementById('bib-modal').classList.remove('open') }

function editBib(id){ openBibForm(id) }

function saveBib(){
  const titulo=document.getElementById('bm-titulo').value.trim();
  if(!titulo){showToast('El tÃ­tulo es obligatorio');return;}
  const obj={
    titulo,
    autor:document.getElementById('bm-autor').value.trim(),
    paginas:parseInt(document.getElementById('bm-paginas').value)||null,
    generos:bibSelectedGenres,
  };
  if(editingBibId){
    const idx=biblioteca.findIndex(b=>b.id===editingBibId);
    if(idx!==-1) biblioteca[idx]={...biblioteca[idx],...obj};
  } else {
    obj.id=Date.now();
    biblioteca.push(obj);
  }
  saveBiblioteca();
  closeBibModal();
  renderAll();
  showToast(editingBibId?'Libro actualizado':'Libro aÃ±adido âœ“');
}

function deleteBib(id){
  if(!confirm('Â¿Eliminar este libro de la biblioteca?'))return;
  biblioteca=biblioteca.filter(b=>b.id!==id);
  saveBiblioteca();
  renderAll();
  showToast('Libro eliminado');
}

// â”€â”€â”€ FORMS LEÃDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingLeidoId = null;

function openLeidoForm(id=null){
  editingLeidoId=id;
  const b=id?leidos.find(x=>x.id===id):null;
  document.getElementById('lm-title').textContent=b?'Editar lectura':'Registrar lectura';
  document.getElementById('lm-titulo').value=b?.titulo||'';
  document.getElementById('lm-autor').value=b?.autor||'';
  document.getElementById('lm-paginas').value=b?.paginas||'';
  document.getElementById('lm-formato').value=b?.formato||'Ebook';
  // Populate mes select
  const mesSel=document.getElementById('lm-mes');
  mesSel.innerHTML='';
  MESES.forEach(m=>{const o=document.createElement('option');o.value=o.textContent=m;mesSel.appendChild(o)});
  mesSel.value=b?.mes||MESES[new Date().getMonth()];
  leidoSelectedGenres=b?.generos?[...b.generos]:[];
  buildGenreChips('lm-genres',leidoSelectedGenres,'leido');
  // Sliders
  CATEGORIAS.forEach(k=>{
    document.getElementById('rng-'+k).value=b?.[k]||0;
    document.getElementById('sl-'+k).textContent=b?.[k]||0;
  });
  // Datalist
  const dl=document.getElementById('lm-datalist');
  dl.innerHTML='';
  biblioteca.forEach(b=>{const o=document.createElement('option');o.value=b.titulo;dl.appendChild(o)});
  updateAvg();
  document.getElementById('leido-modal').classList.add('open');
  setTimeout(()=>document.getElementById('lm-titulo').focus(),100);
}

function closeLeidoModal(){ document.getElementById('leido-modal').classList.remove('open') }

function editLeido(id){ openLeidoForm(id) }

function autofillLeido(val){
  const b=biblioteca.find(x=>x.titulo?.toLowerCase()===val.toLowerCase());
  if(b){
    document.getElementById('lm-autor').value=b.autor||'';
    if(b.paginas) document.getElementById('lm-paginas').value=b.paginas;
    leidoSelectedGenres=b.generos?[...b.generos]:[];
    buildGenreChips('lm-genres',leidoSelectedGenres,'leido');
  }
}

function saveLeido(){
  const titulo=document.getElementById('lm-titulo').value.trim();
  if(!titulo){showToast('El tÃ­tulo es obligatorio');return;}
  const vals=CATEGORIAS.map(k=>parseFloat(document.getElementById('rng-'+k).value));
  const nonZero=vals.filter(v=>v>0);
  const total=nonZero.length?parseFloat((nonZero.reduce((a,b)=>a+b,0)/nonZero.length).toFixed(1)):0;
  const dup=leidos.some(b=>b.id!==editingLeidoId&&b.titulo?.toLowerCase().trim()===titulo.toLowerCase());
  if(dup&&!editingLeidoId){if(!confirm('Ya tienes este libro registrado. Â¿AÃ±adir igualmente?'))return;}
  const obj={
    titulo,
    autor:document.getElementById('lm-autor').value.trim(),
    paginas:parseInt(document.getElementById('lm-paginas').value)||null,
    formato:document.getElementById('lm-formato').value,
    mes:document.getElementById('lm-mes').value,
    generos:leidoSelectedGenres,
    total,
    personaje:parseFloat(document.getElementById('rng-personaje').value),
    prosa:parseFloat(document.getElementById('rng-prosa').value),
    trama:parseFloat(document.getElementById('rng-trama').value),
    aprendizaje:parseFloat(document.getElementById('rng-aprendizaje').value),
    entretenimiento:parseFloat(document.getElementById('rng-entretenimiento').value),
  };
  if(editingLeidoId){
    const idx=leidos.findIndex(b=>b.id===editingLeidoId);
    if(idx!==-1) leidos[idx]={...leidos[idx],...obj};
  } else {
    obj.id=Date.now();
    leidos.push(obj);
  }
  saveLeidos();
  closeLeidoModal();
  renderAll();
  showToast(editingLeidoId?'Lectura actualizada':'Lectura guardada âœ“');
}

function deleteLeido(id){
  if(!confirm('Â¿Eliminar este libro leÃ­do?'))return;
  leidos=leidos.filter(b=>b.id!==id);
  saveLeidos();
  renderAll();
  showToast('Eliminado');
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

function genreTags(generos){
  if(!generos?.length) return '';
  return `<div class="genres">${generos.map(g=>{
    const c=GENRE_COLORS[g]||'#6b8570';
    return `<span class="gtag" style="border-color:${c}44;color:${c}">${g}</span>`;
  }).join('')}</div>`;
}

let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// â”€â”€â”€ CLOSE MODALS ON OVERLAY CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{ if(e.target===o){ o.classList.remove('open') } });
});
</script>
</body>
</html>
